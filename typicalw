#!/bin/bash
set -e

BIN=${TYPICAL_BIN:-bin}
CMD=${TYPICAL_CMD:-cmd}
BUILD_TOOL=${TYPICAL_BUILD_TOOL:-build-tool}
PRE_BUILDER=${TYPICAL_PRE_BUILDER:-pre-builder}
METADATA=${TYPICAL_METADATA:-.typical-metadata}

mkdir -p $METADATA
mkdir -p internal/dependency

CHECKSUM_PATH="$METADATA/checksum "
CHECKSUM_DATA=$(cksum typical/context.go)

if ! [ -s .typical-metadata/checksum ]; then
    cksum typical/context.go > $CHECKSUM_PATH
else
    CHECKSUM_UPDATED=$([ "$CHECKSUM_DATA" == "$(cat $CHECKSUM_PATH )" ] ; echo $?)
fi

if [ "$CHECKSUM_UPDATED" == "1" ] || ! [[ -f $BIN/$PRE_BUILDER ]] ; then 
    echo $CHECKSUM_DATA > $CHECKSUM_PATH
    echo "Build the pre-builder"
    go build -o $BIN/$PRE_BUILDER ./$CMD/$PRE_BUILDER
fi

./$BIN/$PRE_BUILDER $CHECKSUM_UPDATED
./$BIN/$BUILD_TOOL $@ 